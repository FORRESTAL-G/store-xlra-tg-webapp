<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Outsmart Genesis Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #000000);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --accent-color: #a0a0a0; /* Palladio */
            --glow-color: rgba(60, 100, 255, 0.4);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Gestiamo lo scroll internamente */
            display: flex;
            flex-direction: column;
            height: 100vh;
            border-top-left-radius: 25px; /* Effetto Squircle simulato */
            border-top-right-radius: 25px;
        }

        /* Loading Screen */
        #loader {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Handle per il trascinamento */
        .handle-container {
            width: 100%;
            padding-top: 10px;
            padding-bottom: 20px;
            display: flex;
            justify-content: center;
            background: linear-gradient(to bottom, var(--bg-color) 80%, transparent);
            z-index: 10;
        }
        .handle {
            width: 40px;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        /* Container a scorrimento (Snap) */
        .scroll-container {
            flex: 1;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            padding: 50vh 0; /* Spazio per centrare il primo e l'ultimo */
            scrollbar-width: none; /* Nascondi scrollbar Firefox */
        }
        .scroll-container::-webkit-scrollbar { display: none; }

        /* Item Prodotto */
        .item {
            height: 250px; /* Altezza area focus */
            scroll-snap-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            opacity: 0.4;
            transform: scale(0.85);
            filter: blur(2px);
        }

        /* Stato Attivo (Focus) */
        .item.active {
            opacity: 1;
            transform: scale(1.1) translateX(-30px); /* Sposta a sx */
            filter: blur(0);
            z-index: 2;
        }

        /* Immagine Orb */
        .orb-img {
            max-height: 180px;
            filter: drop-shadow(0 0 20px var(--glow-color));
            transition: transform 0.3s ease;
        }

        /* Info Panel (appare a destra) */
        .info-panel {
            position: absolute;
            left: 65%; /* Parte da destra dell'orb */
            top: 50%;
            transform: translateY(-50%);
            width: 160px;
            opacity: 0;
            transition: opacity 0.5s ease 0.2s; /* Ritardo apparizione */
            text-align: left;
            pointer-events: none;
        }
        
        .item.active .info-panel {
            opacity: 1;
        }

        .title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 5px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            font-family: 'Times New Roman', serif; /* Tocco aristocratico */
        }

        .desc {
            font-size: 0.75em;
            color: #aaa;
            line-height: 1.2;
        }

    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div class="handle-container">
        <div class="handle"></div>
    </div>

    <div class="scroll-container" id="scroller">
        </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); // Espande un po' ma mantiene l'UI bottom sheet se lanciato da bottone

        // Configurazione Colori
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#000000';
        
        // Dati Utente
        const user = tg.initDataUnsafe.user || { id: 'TEST_DEV', language_code: 'it' }; // Fallback per test locale
        const isIt = (user.language_code === 'it');

        // URL del tuo Webhook n8n che controlla se l'utente ha diritto ai bonus
        // Restituisce JSON: { "1": "1b", "2": "2d", "3": "3b" } (Esempio)
        const N8N_CHECK_URL = 'https://tuo-webhook-n8n.com/check-bonus'; 
        
        // URL Webhook per generare il link di pagamento
        const N8N_PAY_URL = 'https://tuo-webhook-n8n.com/generate-payment';

        // Definizione Prodotti Base
        const productsDef = [
            { id: 1, price: 50,  credits: 400,   nameIt: "Genesi x400",   nameEn: "Genesis x400" },
            { id: 2, price: 250, priceLabel: "250", credits: 2300,  nameIt: "Genesi x2300",  nameEn: "Genesis x2300" },
            { id: 3, price: 1000, priceLabel: "1.000", credits: 10500, nameIt: "Genesi x10500", nameEn: "Genesis x10500" }
        ];

        let currentActiveId = null;
        let productsMap = {}; // Salveremo qui lo stato (b/d)

        // 1. Inizializzazione e Caricamento Dati
        async function initStore() {
            try {
                // Chiamata a n8n per sapere i bonus
                // In produzione usa fetch reale. Qui simulo la risposta per farti vedere la logica.
                
                // const response = await fetch(N8N_CHECK_URL, {
                //     method: 'POST',
                //     headers: {'Content-Type': 'application/json'},
                //     body: JSON.stringify({ chat_id: user.id })
                // });
                // const statusMap = await response.json(); 
                
                // MOCK RESPONSE (da rimuovere quando colleghi n8n):
                const statusMap = { "1": "1b", "2": "2d", "3": "3b" }; 

                renderProducts(statusMap);
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').remove(), 500);

            } catch (e) {
                console.error("Errore init", e);
                // Fallback in caso di errore: mostra tutto default
                renderProducts({ "1": "1d", "2": "2d", "3": "3d" });
                document.getElementById('loader').remove();
            }
        }

        // 2. Renderizza HTML
        function renderProducts(statusMap) {
            const container = document.getElementById('scroller');
            
            productsDef.forEach(p => {
                const assetCode = statusMap[p.id]; // es. "1b" o "1d"
                const isBonus = assetCode.includes('b');
                
                // Testi
                let title = isIt ? p.nameIt : p.nameEn;
                if (isBonus) title += " + BONUS!";
                
                const desc = isIt 
                    ? "Orb della Genesi - energia pura necessaria alla manifestazione della tua strategia."
                    : "Genesis Orb - pure energy necessary to manifest your communication strategy.";

                // Crea Elemento
                const el = document.createElement('div');
                el.className = 'item';
                el.dataset.id = p.id;
                el.dataset.asset = assetCode; // Per sapere cosa compra
                el.dataset.price = p.price;
                el.dataset.pricelabel = p.priceLabel || p.price;

                el.innerHTML = `
                    <img src="./assets/${assetCode}.png" class="orb-img" alt="Genesis Orb">
                    <div class="info-panel">
                        <div class="title">${title}</div>
                        <div class="desc">${desc}</div>
                    </div>
                `;
                
                // Click per selezionare (e scorrere verso)
                el.addEventListener('click', () => {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    tg.HapticFeedback.impactOccurred('light');
                });

                container.appendChild(el);
            });

            setupScrollObserver();
        }

        // 3. Logica Scroll e Focus
        function setupScrollObserver() {
            const container = document.getElementById('scroller');
            const items = document.querySelectorAll('.item');

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Rimuovi active da tutti
                        items.forEach(i => i.classList.remove('active'));
                        // Aggiungi al corrente
                        entry.target.classList.add('active');
                        
                        updateMainButton(entry.target);
                        
                        // Vibrazione leggera quando cambia il focus
                        if (currentActiveId !== entry.target.dataset.id) {
                            tg.HapticFeedback.selectionChanged();
                            currentActiveId = entry.target.dataset.id;
                        }
                    }
                });
            }, {
                root: container,
                threshold: 0.6 // Deve essere ben visibile (60%)
            });

            items.forEach(item => observer.observe(item));
        }

        // 4. Gestione Main Button
        function updateMainButton(item) {
            const price = item.dataset.pricelabel;
            const text = isIt ? `ACQUISTA ORA - ${price} CHF` : `BUY NOW - ${price} CHF`;
            
            tg.MainButton.setText(text);
            tg.MainButton.show();
            
            // Rimuovi listener precedenti per non accumulare chiamate
            tg.MainButton.offClick(handleBuy); 
            tg.MainButton.onClick(() => handleBuy(item));
        }

        const handleBuy = async (item) => {
            tg.MainButton.showProgress();
            tg.HapticFeedback.notificationOccurred('success');

            const payload = {
                tg_id: user.id,
                tier_id: item.dataset.id,
                asset_code: item.dataset.asset // passiamo anche se è bonus o no per sicurezza
            };

            try {
                // Chiamata al Webhook n8n per generare il link
                const res = await fetch(N8N_PAY_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                
                if (data.url) {
                    tg.close(); // Chiudiamo la webapp prima di aprire il link? Opzionale.
                    // O meglio, apriamo il link che porterà a Stripe
                    Telegram.WebApp.openLink(data.url);
                } else {
                    alert("Errore generazione link");
                    tg.MainButton.hideProgress();
                }

            } catch (err) {
                console.error(err);
                tg.MainButton.hideProgress();
                alert("Connection Error");
            }
        };

        // Avvio
        initStore();

    </script>
</body>
</html>